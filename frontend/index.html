<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuleMKW - Ruleta de Circuitos</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <!-- Cabecera -->
        <header>
            <h1>üèÅ RuleMKW</h1>
            <div class="user-info">
                <div v-if="usuario" class="user-links">
                    <a href="perfil.html" class="user-name">
                        {{ usuario }}
                    </a>
                    <a href="../backend/logout.php" class="logout-link">
                        Salir
                    </a>
                </div>
                <div v-else class="guest-links">
                    <a href="../backend/login.php">Iniciar Sesi√≥n</a>
                    <a href="../backend/registro.php">Registrarse</a>
                </div>
            </div>
        </header>

        <!-- Mensajes -->
        <div v-if="mensaje" class="mensaje" :class="tipoMensaje">
            {{ mensaje }}
        </div>

        <!-- Contenido principal -->
        <main>
            <!-- ============================================
                 SECCI√ìN 1: RULETA Y CONTROLES
                 ============================================ -->
            <section class="seccion-ruleta">
                <h2>Ruleta de Circuitos</h2>
                
                <!-- Contadores y botones -->
                <div class="controles-ruleta">
                    <div class="contador-seleccion">
                        <span class="numero-grande">{{ seleccionados }}</span>
                        <span>circuitos seleccionados</span>
                        <div class="contador-limitador" :class="{
                            'limite-ok': seleccionados >= 2 && seleccionados <= 4,
                            'limite-poco': seleccionados < 2,
                            'limite-mucho': seleccionados > 4
                        }">
                            {{ seleccionados }}/4
                            <span v-if="seleccionados < 2"> (m√≠nimo 2)</span>
                        </div>
                    </div>
                    
                    <div class="botones-masivos">
                        <button @click="seleccionarTodos" class="btn-masivo btn-todos">
                            Seleccionar Todos
                        </button>
                        <button @click="deseleccionarTodos" class="btn-masivo btn-ninguno">
                            Deseleccionar Todos
                        </button>
                    </div>
                </div>

                <!-- RULETA VISUAL (4 posiciones) -->
                <div class="ruleta-visual">
                    <!-- Posici√≥n 1: Arriba Izquierda (Azul) -->
                    <div class="slot-ruleta posicion-1" :class="{ 
                        'vac√≠o': resultados.length < 1,
                        'iluminado': girando && !ganador,
                        'ganador': ganador && resultados[0] && resultados[0].ganador
                    }">
                        <div v-if="resultados[0]" class="contenido-slot">
                            <div class="imagen-circuito">
                                <img :src="'../' + resultados[0].imagen" 
                                     :alt="resultados[0].nombre"
                                     @error="manejarErrorImagen">
                            </div>
                            <div class="info-circuito">
                                <h4>{{ resultados[0].nombre }}</h4>
                                <span class="badge-copa">{{ resultados[0].copa.nombre }}</span>
                            </div>
                        </div>
                        <div v-else class="slot-vacio">
                            <div class="indicador-pos">1</div>
                            <span>Esperando circuito...</span>
                        </div>
                    </div>

                    <!-- Posici√≥n 2: Arriba Derecha (Rojo) -->
                    <div class="slot-ruleta posicion-2" :class="{ 
                        'vac√≠o': resultados.length < 2,
                        'iluminado': girando && !ganador,
                        'ganador': ganador && resultados[1] && resultados[1].ganador
                    }">
                        <div v-if="resultados[1]" class="contenido-slot">
                            <div class="imagen-circuito">
                                <img :src="'../' + resultados[1].imagen" 
                                     :alt="resultados[1].nombre"
                                     @error="manejarErrorImagen">
                            </div>
                            <div class="info-circuito">
                                <h4>{{ resultados[1].nombre }}</h4>
                                <span class="badge-copa">{{ resultados[1].copa.nombre }}</span>
                            </div>
                        </div>
                        <div v-else class="slot-vacio">
                            <div class="indicador-pos">2</div>
                            <span>Esperando circuito...</span>
                        </div>
                    </div>

                    <!-- BOT√ìN CENTRAL DE GIRAR -->
                    <div class="centro-ruleta">
                        <button @click="girarRuleta" 
                                :disabled="!puedeGirar"
                                class="btn-girar-ruleta"
                                :class="{ 'girando': girando }">
                            <div class="icono-girar">üéÆ</div>
                            <span>{{ girando ? 'GIRANDO...' : '¬°GIRAR RULETA!' }}</span>
                        </button>
                    </div>

                    <!-- Posici√≥n 3: Abajo Izquierda (Verde) -->
                    <div class="slot-ruleta posicion-3" :class="{ 
                        'vac√≠o': resultados.length < 3,
                        'iluminado': girando && !ganador,
                        'ganador': ganador && resultados[2] && resultados[2].ganador
                    }">
                        <div v-if="resultados[2]" class="contenido-slot">
                            <div class="imagen-circuito">
                                <img :src="'../' + resultados[2].imagen" 
                                     :alt="resultados[2].nombre"
                                     @error="manejarErrorImagen">
                            </div>
                            <div class="info-circuito">
                                <h4>{{ resultados[2].nombre }}</h4>
                                <span class="badge-copa">{{ resultados[2].copa.nombre }}</span>
                            </div>
                        </div>
                        <div v-else class="slot-vacio">
                            <div class="indicador-pos">3</div>
                            <span>Esperando circuito...</span>
                        </div>
                    </div>

                    <!-- Posici√≥n 4: Abajo Derecha (Amarillo) -->
                    <div class="slot-ruleta posicion-4" :class="{ 
                        'vac√≠o': resultados.length < 4,
                        'iluminado': girando && !ganador,
                        'ganador': ganador && resultados[3] && resultados[3].ganador
                    }">
                        <div v-if="resultados[3]" class="contenido-slot">
                            <div class="imagen-circuito">
                                <img :src="'../' + resultados[3].imagen" 
                                     :alt="resultados[3].nombre"
                                     @error="manejarErrorImagen">
                            </div>
                            <div class="info-circuito">
                                <h4>{{ resultados[3].nombre }}</h4>
                                <span class="badge-copa">{{ resultados[3].copa.nombre }}</span>
                            </div>
                        </div>
                        <div v-else class="slot-vacio">
                            <div class="indicador-pos">4</div>
                            <span>Esperando circuito...</span>
                        </div>
                    </div>
                </div>

                <!-- Mensajes informativos -->
                <div v-if="seleccionados < 2 || seleccionados > 4" class="mensaje-info">
                    Selecciona entre 2 y 4 circuitos para usar la ruleta.
                </div>
                
                <div v-if="!usuario" class="mensaje-info">
                    <a href="../backend/login.php">Inicia sesi√≥n</a> para guardar tus estad√≠sticas.
                </div>
            </section>

            <!-- ============================================
                 SECCI√ìN 2: SELECCI√ìN POR COPAS (ABAJO)
                 ============================================ -->
            <section class="seccion-copas">
                <h2>Selecciona Circuitos por Copa</h2>
                
                <!-- Grid de copas (im√°genes clickeables) -->
                <div class="grid-copas">
                    <div v-for="copa in copasConCircuitos" :key="copa.id" class="card-copa">
                        <!-- Imagen de la copa (click para abrir/cerrar) -->
                        <div class="imagen-copa-contenedor" @click="alternarCopa(copa.id)">
                            <img :src="'../' + copa.imagen" 
                                 :alt="copa.nombre"
                                 class="imagen-copa"
                                 @error="manejarErrorImagen">
                            <div class="badge-seleccionados" v-if="contarSeleccionadosEnCopa(copa.id) > 0">
                                {{ contarSeleccionadosEnCopa(copa.id) }}/{{ copa.circuitos.length }}
                            </div>
                        </div>
                        
                        <!-- Nombre de la copa -->
                        <h3 class="nombre-copa">{{ copa.nombre }}</h3>
                        
                        <!-- Circuitos de esta copa (se muestra al hacer click) -->
                        <div v-for="circuito in copa.circuitos" 
                            :key="circuito.id"
                            class="circuito-desplegable"
                            :class="{ 'seleccionado': circuito.seleccionado }"
                            @click.stop="alternarCircuito(circuito)">
                            
                            <div class="check-circuito" @click.stop>
                                <input type="checkbox" 
                                    :checked="circuito.seleccionado"
                                    @change="alternarCircuito(circuito)"
                                    :disabled="!circuito.seleccionado && seleccionados >= 4">
                            </div>
                                
                            <div class="imagen-circuito-peque">
                                <img :src="'../' + circuito.imagen" 
                                     :alt="circuito.nombre"
                                     @error="manejarErrorImagen">
                            </div>
                                
                            <div class="info-circuito-peque">
                                <span class="nombre-circuito-peque">{{ circuito.nombre }}</span>
                            </div>
                        </div>
                            
                            <div class="controles-copa">
                                <button @click.stop="seleccionarTodosEnCopa(copa.id)" 
                                        class="btn-copa btn-todos-copa">
                                    ‚úÖ Todos
                                </button>
                                <button @click.stop="deseleccionarTodosEnCopa(copa.id)" 
                                        class="btn-copa btn-ninguno-copa">
                                    ‚ùå Ninguno
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============================================
                 SECCI√ìN 3: GANADOR Y ESTAD√çSTICAS
                 ============================================ -->
            <section v-if="ganador" class="seccion-ganador">
                <div class="contenedor-ganador">
                    <div class="cabecera-ganador">
                        <h2>üèÜ ¬°CIRCUITO GANADOR!</h2>
                        <p>Seleccionado aleatoriamente de los 4 circuitos</p>
                    </div>
                    
                    <div class="info-ganador-detallada">
                        <div class="imagen-ganador-grande">
                            <img :src="'../' + ganador.imagen" 
                                 :alt="ganador.nombre"
                                 @error="manejarErrorImagen">
                        </div>
                        
                        <div class="detalles-ganador">
                            <h3>{{ ganador.nombre }}</h3>
                            <div class="copa-ganador">
                                <span class="badge-copa-ganador">Copa: {{ ganador.copa.nombre }}</span>
                            </div>
                            <p class="descripcion-ganador">
                                Este circuito ha sido seleccionado como ganador de la ruleta.
                                <span v-if="usuario" class="estadistica-guardada">
                                    ‚úÖ Estad√≠stica guardada en tu perfil
                                </span>
                            </p>
                            
                            <button @click="girarRuleta" class="btn-nueva-ruleta">
                                üîÑ Girar Nueva Ruleta
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Estad√≠sticas r√°pidas -->
            <section v-if="estadisticas && usuario" class="seccion-estadisticas">
                <h3>Tus Estad√≠sticas R√°pidas</h3>
                <div class="grid-estadisticas">
                    <div class="stat-item">
                        <div class="stat-numero">{{ estadisticas.total_tiradas || 0 }}</div>
                        <div class="stat-label">Total Tiradas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-numero">{{ estadisticas.total_circuitos || 0 }}</div>
                        <div class="stat-label">Circuitos Jugados</div>
                    </div>
                    <div class="stat-item" v-if="estadisticas.circuito_mas_jugado">
                        <div class="stat-numero">{{ estadisticas.veces_jugado || 0 }}</div>
                        <div class="stat-label">{{ estadisticas.circuito_mas_jugado }}</div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Pie de p√°gina -->
        <footer>
            <p>TFG RuleMKW - Jes√∫s Antonio Hern√°ndez G√≥mez</p>
        </footer>
    </div>

    <script src="js/app.js"></script>
</body>
</html>